<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>muZic</title>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <link rel="stylesheet"
              type="text/css"
              href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
        <script type='text/javascript'
                src="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
        <link rel="stylesheet"
              type="text/css"
              href="http://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.min.css">
        <style>
            .selectors_box {
               background: #eaeaed;
               text-align: center;
            }
            .player_box {
               background: #eaeaed;
               text-align: center;
            }
        </style>
    </head>
    <body>
       <div>
          <div class="selectors_box">
             <select id="pls_content"></select>
             <select id="items_content"></select>
          </div>
          <div class="player_box">
             <img id="pl_icon"></img>
             <div>
                <label id="pl_pos" for="pl_slider"></label>
                <input id="pl_slider" type="range" min="0" max="10" value="0"></input>
                <label id="pl_total_len" for="pl_slider"></label>
             </div>
             <div>
                <button id="pl_prev_bt" type="button" class="btn btn-default btn-xs">
                   <span class="glyphicon glyphicon-fast-backward"></span>
                </button>
                <button id="pl_play_bt" type="button" class="btn btn-default btn-xs">
                   <span class="glyphicon glyphicon-pause"></span>
                </button>
                <button id="pl_stop_bt" type="button" class="btn btn-default btn-xs">
                   <span class="glyphicon glyphicon-stop"></span>
                </button>
                <button id="pl_next_bt" type="button" class="btn btn-default btn-xs">
                   <span class="glyphicon glyphicon-fast-forward"></span>
                </button>
             </div>
          </div>
       </div>

        <script>
           $(function () {
              "use strict";

              var cur_list = "";
              var cur_item = "";
              var cur_item_pos = 0;
              var cur_item_len = 0;

              // if user is running mozilla then use it's built-in WebSocket
              window.WebSocket = window.WebSocket || window.MozWebSocket;

              // open connection
              console.log(location);
              var connection = new WebSocket('ws://'+location.hostname+':1337');

              var pl_play_bt = document.getElementById("pl_play_bt");
              pl_play_bt.onclick = function()
              {
                 connection.send(JSON.stringify({ type:'PlayPause' }));
              }

              var pl_stop_bt = document.getElementById("pl_stop_bt");
              pl_stop_bt.onclick = function()
              {
                 connection.send(JSON.stringify({ type:'Stop' }));
              }

              var pl_next_bt = document.getElementById("pl_next_bt");
              pl_next_bt.onclick = function()
              {
                 connection.send(JSON.stringify({ type:'Next' }));
              }

              var pl_prev_bt = document.getElementById("pl_prev_bt");
              pl_prev_bt.onclick = function()
              {
                 connection.send(JSON.stringify({ type:'Prev' }));
              }

              var pl_slider = document.getElementById("pl_slider");
              pl_slider.onchange = function()
              {
                 connection.send(JSON.stringify({ type:'Change-Position', item: cur_item, pos: pl_slider.value }));
              }

              // most important part - incoming messages
              connection.onmessage = function (message) {
                 // try to parse JSON message. Because we know that the server always returns
                 // JSON this should work without any problem but we should make sure that
                 // the massage is not chunked or otherwise damaged.
                    try {
                       var json = JSON.parse(message.data);
                    } catch (e) {
                       console.log('This doesn\'t look like a valid JSON: ', message.data);
                       return;
                    }

                 console.log(json);
                 if (json.type === 'List-Playlists') {
                    /* List playlists */
                    var html = "";
                    if (cur_list == "") html = "<option>---</option>";
                    for (var item of json.data)
                       html = html + '<option value="' + item.name + '">' + item.name + '</option>';
                    document.getElementById("pls_content").innerHTML = html;
                    document.getElementById("pls_content").onchange = function()
                    {
                       console.log(JSON.stringify({ type:'Select-Playlist', data: this.value }));
                       connection.send(JSON.stringify({ type:'Select-Playlist', data: this.value }));
                    }
                 }
                 else if (json.type === 'List-Items') {
                    /* List items */
                    var html = "";
                    if (cur_item == "") html = "<option>---</option>";
                    for (var item in json.data)
                       html = html + '<option data-icon="'+json.data[item.icon]+'" value="' + item + '">' + json.data[item].title + '</option>';
                    document.getElementById("items_content").innerHTML = html;
                    document.getElementById("items_content").onchange = function()
                    {
                       connection.send(JSON.stringify({ type:'Select-Item', data: this.value }));
                    }
                 }
                 else if (json.type === 'Player-Progress') {
                    if (json.list != cur_list)
                    {
                       cur_list = json.list;
                       document.getElementById("pls_content").value = cur_list;
                    }
                    if (json.item != cur_item)
                    {
                       cur_item = json.item;
                       document.getElementById("items_content").value = cur_item;
                    }
                    if (json.state == "PLAY")
                    {
                       pl_play_bt.innerHTML = '<span class="glyphicon glyphicon-pause"></span>';
                    }
                    else
                    {
                       pl_play_bt.innerHTML = '<span class="glyphicon glyphicon-play"></span>';
                    }
                    if (json.len != cur_item_len)
                    {
                       var date = new Date;
                       date.setTime(0);
                       date.setSeconds(json.len);
                       document.getElementById("pl_total_len").innerHTML = date.toISOString().substr(11, 8);;
                       pl_slider.max = json.len;
                       cur_item_len = json.len;
                    }
                    if (json.pos != cur_item_pos)
                    {
                       var date = new Date;
                       date.setTime(0);
                       date.setSeconds(json.pos);
                       document.getElementById("pl_pos").innerHTML = date.toISOString().substr(11, 8);;
                       if (document.getElementById("pl_icon").src != json.icon)
                          document.getElementById("pl_icon").src = json.icon;
                       pl_slider.value = json.pos;
                       cur_item_pos = json.pos;
                    }
                 }
                 else {
                    console.log('Hmm..., I\'ve never seen JSON like this: ', json);
                 }
              };
           });
        </script>
    </body>
</html>
