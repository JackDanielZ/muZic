<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>muZic</title>

        <style>
            .selectors_box {
               background: #eaeaed;
               text-align: center;
            }
            .player_box {
               background: #eaeaed;
               text-align: center;
            }
        </style>
    </head>
    <body>
       <div>
          <div class="selectors_box">
             <select id="pls_content"></select>
             <select id="items_content"></select>
          </div>
          <div class="player_box">
             <img id="pl_icon"></img>
             <p id="pl_pos"></p>
          </div>
       </div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script>
           $(function () {
              "use strict";

              var cur_item = "";
              var cur_item_pos = 0;
              var cur_item_len = 0;

              // if user is running mozilla then use it's built-in WebSocket
              window.WebSocket = window.WebSocket || window.MozWebSocket;

              // open connection
              console.log(location);
              var connection = new WebSocket('ws://'+location.hostname+':1337');

              // most important part - incoming messages
              connection.onmessage = function (message) {
                 // try to parse JSON message. Because we know that the server always returns
                 // JSON this should work without any problem but we should make sure that
                 // the massage is not chunked or otherwise damaged.
                    try {
                       var json = JSON.parse(message.data);
                    } catch (e) {
                       console.log('This doesn\'t look like a valid JSON: ', message.data);
                       return;
                    }

                 console.log(json);
                 if (json.type === 'List-Playlists') {
                    /* List playlists */
                    var html = "";
                    for (var item of json.data)
                       html = html + '<option value="' + item.name + '">' + item.name + '</option>';
                    document.getElementById("pls_content").innerHTML = html;
                    document.getElementById("pls_content").onchange = function()
                    {
                       console.log(JSON.stringify({ type:'Select-Playlist', data: this.value }));
                       connection.send(JSON.stringify({ type:'Select-Playlist', data: this.value }));
                    }
                 }
                 else if (json.type === 'List-Items') {
                    /* List items */
                    var html = "";
                    for (var item in json.data)
                       html = html + '<option data-icon="'+json.data[item.icon]+'" value="' + item + '">' + json.data[item].title + '</option>';
                    if (html == "") html = "<option>None</option>";
                    document.getElementById("items_content").innerHTML = html;
                    document.getElementById("items_content").onchange = function()
                    {
                       connection.send(JSON.stringify({ type:'Select-Item', data: this.value }));
                    }
                 }
                 else if (json.type === 'Player-Progress') {
                    if (json.item != cur_item)
                    {
                       cur_item = json.item;
                       document.getElementById("pl_icon").src = json.icon;
                    }
                    document.getElementById("pl_pos").innerHTML = json.pos + " / " + json.len;
                 }
                 else {
                    console.log('Hmm..., I\'ve never seen JSON like this: ', json);
                 }
              };
           });
        </script>
    </body>
</html>
